[
["035-mutate.html", "7 Verbs 3: mutate 7.1 Key takeaways 7.2 Read in some data 7.3 Simple arithmetic 7.4 Creating categories 7.5 Bonus: Fun with date and time", " 7 Verbs 3: mutate table { font-size:.9em; } 7.1 Key takeaways NOTE: Most journalism tutorials do group_by/summarise BEFORE they introduce mutate. But most computer science tutorials reverse that order. The reason is that journalists often don’t have datasets that have many numbers, so the simple arithmetic isn’t as important. mutate just means “compute”, or convert one or more variables into something new. mutate is the same thing as creating a new column in Excel with a formula There are several common mutate tasks. The most important for us are: Convert unstandardized data into standardized, such as yes-or-no variables or all lower case Use arithmetic on numeric variables Use conditional statements to put different values on variables, instead of filtering one at a time. OPTIONAL: Mutate can replace text or values Change the data type from, say, text to date and time. 7.2 Read in some data Start with the Arizona immunization data that some other chapters have worked with, loading it and the tidyverse to follow along. Here are the packages and data used for this chapter: library(tidyverse) library(knitr) # used for slightly better looking tables library(DT) # even more options with tables library(lubridate) # used for working with dates library(janitor) # used to clean up dirty data and change column names. load(&quot;data/az-immunizations-grade6.Rda&quot;) # you may need to change the path to wherever you saved the data 7.3 Simple arithmetic Use the usual arithmetic operators to calculate numbers and create a new column: + Addition - Subtraction * Multiplication / Division This example creates a new data frame called immune_pct from a few columns of the original: immune_pct &lt;- grade6_counts %&gt;% select ( school_name, city, school_type, enrolled, num_immune_mmr) %&gt;% mutate (pct_immune = ( num_immune_mmr/enrolled) * 100) Here’s what it looks like: school_name city school_type enrolled num_immune_mmr pct_immune ABRAHAM LINCOLN TRADITIONAL SCHOOL PHOENIX PUBLIC 59 58 98.3 ACACIA ELEMENTARY SCHOOL PHOENIX PUBLIC 134 134 100.0 ACADEMY DEL SOL - HOPE TUCSON CHARTER 53 52 98.1 ACADEMY OF MATH AND SCIENCE TUCSON CHARTER 42 40 95.2 ACADEMY OF MATH AND SCIENCE CAMELBACK PHOENIX CHARTER 113 113 100.0 ACADEMY OF MATHEMATICS AND SCIENCE SOUTH PHOENIX CHARTER 56 55 98.2 7.4 Creating categories Sometimes, you want to create categories out of more detailed information. In this case, a threshold of 90 percent immunization is considered the limit under which there is a threat of a measles outbreak, also known as “herd immunity”. To categorize each schools as above or under that level, we need to create a new variable that is based on the value of the percentage we just calcluated. That’s done using an if_else statement, which is in the form: if_else ( condition, new value if it&#39;s true, new value if it&#39;s not true) For example: immune_pct &lt;- immune_pct %&gt;% mutate ( threshold_met = if_else ( pct_immune &gt;= 90, &quot;Meets threshold&quot;, &quot;Below threshold&quot;) ) Now we can do some grouping by the new categories: immune_pct %&gt;% group_by (school_type, threshold_met) %&gt;% summarise ( school_ct = n(), enrolled = sum(enrolled)) %&gt;% kable() school_type threshold_met school_ct enrolled CHARTER Below threshold 40 2344 CHARTER Meets threshold 153 10856 PRIVATE Below threshold 10 324 PRIVATE Meets threshold 57 2364 PUBLIC Below threshold 18 1223 PUBLIC Meets threshold 630 66928 You can practice rolling up by looking at the percent by type. immune_pct %&gt;% group_by (school_type, threshold_met) %&gt;% summarise ( schools = n(), students = sum(enrolled)) %&gt;% mutate ( pct_school_type = schools / sum(schools, na.rm=TRUE) * 100, pct_enrolled = students / sum(students, na.rm=TRUE) * 100 ) %&gt;% filter ( threshold_met == &quot;Below threshold&quot;) %&gt;% kable(digits=1) school_type threshold_met schools students pct_school_type pct_enrolled CHARTER Below threshold 40 2344 20.7 17.8 PRIVATE Below threshold 10 324 14.9 12.1 PUBLIC Below threshold 18 1223 2.8 1.8 You can read this table to say, “Nearly one-fifth of charter school 6th-graders attended schools that did not meet the immunization standards to prevent measles outbreaks.” (The wording is tough here to avoid saying “schools” over and over! ) This strategy can also be used to set unreal values to the special NA as in the MAP murder data that uses the value 999 instead of “unknown” for an age. This is common in survey data. 7.5 Bonus: Fun with date and time Sometimes your data came to you as text, but you need to treat it as numbers; sometimes you want to turn something that looks like a date into an actual date, allowing for date math and date functions. This is called changing the data type. (This example uses the library lubridate, which may not be installed in your computer. If you’re following along, you may need to install it in the console.) my_link &lt;- &quot;https://cronkitedata.github.io/cronkite-docs/assets/data/csv/opioidemscalls.csv&quot; #use it in a read_csv command opioid_calls_orig &lt;- read_csv(my_link) opioid_calls &lt;- opioid_calls_orig %&gt;% clean_names() %&gt;% select (objectid, incident_date_char = incident_date, narcan= narcan_naloxone_given, is_asu_student, is_homeless=is_homeles) head(opioid_calls) The date and time in this dataset is a character field, but we want to convert it to a date field and a separate time field. Here is an example of doing that, using the library lubridate At first, we might just want to get the date value out of the character string. It’s in the form month/day/year hour:minute, so we can use the lubridate::mdy_hm function, which tries to guess how the character string is formatted: opioid_calls %&gt;% mutate ( incident_date = mdy_hm(incident_date_char)) %&gt;% select (incident_date, incident_date_char:is_homeless) %&gt;% head() Notice that the new variable is of the type &lt;S3: POSIXct&gt;, which refers to a date-time combined variable. Let’s say I want to distinguish weekends from weekdays in this dataset. First, we have to define weekend. Here’s one definition, but you might want to use another: A weekend is anytime after 3pm on Friday through 6pm on Sunday. (The hour variable is in military time.) opioid_calls %&gt;% mutate (incident_date = mdy_hm(incident_date_char), day_of_week = wday(incident_date) , weekday = weekdays(incident_date), hour = hour(incident_date), weekend = case_when ( day_of_week == 7 ~ &quot;Yes&quot;, day_of_week == 6 &amp; hour &gt;= 15 ~ &quot;Yes&quot;, day_of_week == 1 &amp; hour &lt;= 18 ~ &quot;Yes&quot;, TRUE ~ &quot;No&quot; ) ) %&gt;% select (weekend, weekday, hour) %&gt;% head (60) %&gt;% datatable( ) "]
]
